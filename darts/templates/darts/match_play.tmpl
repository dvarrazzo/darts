{% extends "darts/base.tmpl" %}

{% block header %}
{{ block.super }}
<script type="text/javascript">
  $(function () {
    $('table.score td.score').click(function(e) {
      var value_elem = $(this);
      var player_elem = $('table.players tr.current');
      var throw_number = player_elem.children('.throw').map(
        function (i) { if ($(this).hasClass('current')) return i; })[0] + 1;
      var round_number = parseInt($('.players').attr('data-round'));

      // calc new score
      var value = parseInt(value_elem.attr('data-value'));
      var score_elem = $('table.players tr.current td.leg_score');
      var new_score = parseInt(score_elem.text()) - value;
      var throw_code = value_elem.attr('data-code');

      // check end of round
      var win = false;
      var bust = false;
      if (new_score == 0 && /D[0-9]+|BULL/.test(throw_code)) {
        win = true;
        writeComment('WIN!');
        $('#next-leg').show();
      } else if (new_score <= 1) {
        bust = true;
        writeComment('BUST!');
      }

      // Write throw
      var throw_elem = player_elem.children('td.throw.current');
      throw_elem.text(throw_code);
      throw_elem.attr('data-value', value);

      // If bust, revert the score to before the round
      if (bust) {
        new_score += roundScore(player_elem);
      }

      score_elem.text(new_score);

      // Advance player/throw
      var throw_next = throw_elem.next();
      if (!bust && throw_next.hasClass('throw')) {
        // new throw, same player
        throw_elem.removeClass('current');
        if (!win) {
          throw_next.addClass('current');
        }
        else {
          player_elem.removeClass('current');
        }
      }
      else {
        // new player, first throw
        var player_next = player_elem.next();
        if (!player_next.length) {
          player_next = $('table.players tr.player:first');
        }

        if (!(win || bust)) { writeComment(roundScore(player_elem)); }
        throw_elem.removeClass('current');
        player_elem.removeClass('current');

        // Prepare the next player only if the leg isn't finished
        if (!win) {
          $('.players').attr('data-round', round_number + 1);
          player_next.addClass('current');
          player_next.children('td.throw')
            .text('-')
            .attr('data-value', '')
            .first().addClass('current');
          writeComment('');
        }
      }

      data = {
        csrfmiddlewaretoken: '{{csrf_token}}',
        leg_number: {{game.current_leg.number}},
        player_id: player_elem.attr('data-id'),
        round_number: round_number,
        throw_number: throw_number,
        throw_code: throw_code,
        throw_value: value,
        leg_score: new_score,
        win: win ? 1 : 0,
        bust: bust ? 1 : 0,
      };

      // Send to the server our action.
      $.ajax({
        url: '{% url darts_match_throw game.match.id %}',
        type: 'POST',
        data: data,
        error: function (xhr) {
          if (xhr.status == 400) {
            alert(xhr.responseText);
          }
          else {
            alert("error: " + xhr.statusText);
          }
        },
        success: function (data) {
        }
      });
    });

    var roundScore = function (elem) {
      var score = 0;
      elem.children('.throw').each(function() {
        score += parseInt($(this).attr('data-value')) || 0;
      });
      return score;
    };

    var writeComment = function (text) {
      $('.players tr.current .comment').text(text);
    };


  });
</script>
{% endblock header %}


{% block content %}

<table class="players" data-round="{{game.current_round.number}}">
  <tr>
    <th>Player</th>
    <th>Score</th>
    <th colspan="3">Last throws</th>
  </tr>
{% for p in game.get_players_and_leg_score %}
  <tr class="player {% ifequal p game.current_player %}current{% endifequal %}"
      data-id="{{p.id}}">
    <td class="player">
      <img class="avatar" src="{{p.avatar.url}}" />
      <span class="username">{{p.username}}</span>
    </td>
    <td class="leg_score">{{p.leg_score}}</td>
  {% for t in p.last_throws %}
    <td class="throw {% if t.current %}current{% endif %}">
      {{t.code|default:'-'}}
    </td>
  {% endfor %}
    <td class="comment"></td>
  </tr>
{% endfor %}
</table>

<p id="next-leg" style="display: none">
  <a href=".">Go to next leg</a>
</p>

{% for table in game.score_tables %}
  <table class="score">
    {% for row in table %}
    <tr>
      {% for score in row %}
      <td class="score"
          data-code="{{score.code}}" data-value="{{score.value}}">
        {{score.label}}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
{% endfor %}

{% endblock content %}


